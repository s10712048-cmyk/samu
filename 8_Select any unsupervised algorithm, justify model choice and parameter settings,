import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.cluster import KMeans
from sklearn.datasets import make_classification
from sklearn.decomposition import PCA
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import confusion_matrix


print("Generating Imbalanced Transaction Data (98% Normal, 2% Fraud)...")

X, y = make_classification(n_samples=2000, n_features=10, n_informative=5,
                           n_redundant=0, n_clusters_per_class=1,
                           weights=[0.98], flip_y=0, random_state=42)

df = pd.DataFrame(X)
print(f"Dataset Shape: {df.shape}")
print("Data generated successfully.")


print("\nScaling features for K-Means...")
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)


print("Training K-Means with K=2...")
kmeans = KMeans(n_clusters=2, n_init=10, random_state=42)
y_pred = kmeans.fit_predict(X_scaled)


counts = pd.Series(y_pred).value_counts()
print("\nCluster Distribution:")
print(counts)

fraud_cluster = counts.idxmin() 
print(f"\nAssumed Fraud Cluster ID: {fraud_cluster}")


y_pred_mapped = np.where(y_pred == fraud_cluster, 1, 0)

print("\nConfusion Matrix (Unsupervised):")
print(confusion_matrix(y, y_pred_mapped))


print("\nReducing dimensions to 2D for visualization...")
pca = PCA(n_components=2)
X_pca = pca.fit_transform(X_scaled)

plt.figure(figsize=(10, 6))

plt.scatter(X_pca[y_pred == 0, 0], X_pca[y_pred == 0, 1], label='Cluster 0', alpha=0.5)

plt.scatter(X_pca[y_pred == 1, 0], X_pca[y_pred == 1, 1], label='Cluster 1', alpha=0.5)


plt.scatter(kmeans.cluster_centers_[:, 0], kmeans.cluster_centers_[:, 1],
            s=200, c='red', marker='X', label='Centroids')

plt.title('Fraud Detection using K-Means (PCA Reduced)')
plt.legend()
plt.show()


sample_tx = X_scaled[0].reshape(1, -1)
pred_label = kmeans.predict(sample_tx)[0]
status = "Fraud" if pred_label == fraud_cluster else "Normal"
print(f"\nPrediction for transaction ID 0: Cluster {pred_label} ({status})")
